<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ОТВЕТИКСЫ МА БОЙ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    html, body { height: 100%; min-height: 100%; }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #18181b 0%, #232046 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      color: #e5e7eb;
      transition: background 0.7s cubic-bezier(0.4,0,0.2,1);
      overflow-x: hidden;
    }
    .watermark {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      z-index: 0; pointer-events: none; user-select: none;
      display: flex; align-items: center; justify-content: center;
      font-size: 10vw; font-weight: 900; color: #232046; opacity: 0.10;
      text-align: center; letter-spacing: 0.05em; line-height: 1.1;
      transition: transform 0.5s cubic-bezier(0.4,0,0.2,1);
    }
    #affridoWatermark {
      position: fixed; left: 1.2rem; bottom: 1.2rem; z-index: 30;
      color: #818cf8; opacity: 0.38; font-size: 1.08rem;
      font-family: monospace; pointer-events: none; user-select: none;
      letter-spacing: 0.04em;
    }
    .search-container {
      background: linear-gradient(135deg, #232046 0%, #312e81 100%);
      border-radius: 1.25rem;
      box-shadow: 0 4px 32px 0 rgba(36,32,70,0.13);
      padding: 2rem 1.5rem 1.5rem 1.5rem;
      margin: 2.5rem auto 1.5rem auto;
      max-width: 540px;
      position: relative;
    }
    .search-input {
      width: 100%; border-radius: 0.75rem; border: none;
      padding: 1.1rem 1.1rem 1.1rem 1.1rem; font-size: 1.1rem;
      background: #23232b; color: #f3f4f6; font-weight: 500;
      outline: none; transition: box-shadow 0.2s;
      box-shadow: 0 2px 8px 0 rgba(80,60,200,0.08);
    }
    .search-input:focus { box-shadow: 0 0 0 2px #6366f1; }
    .search-btn {
      position: absolute; right: 1.2rem; top: 50%; transform: translateY(-50%);
      background: #6366f1; color: #fff; border: none; border-radius: 9999px;
      width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center;
      font-size: 1.25rem; box-shadow: 0 2px 8px 0 rgba(99,102,241,0.10);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .search-btn:hover { background: #4f46e5; }
    .results-list { margin: 0 auto; max-width: 700px; }
    .ticket-card {
      background: #23232b; color: #e5e7eb; border-radius: 1.1rem;
      border: 1.5px solid #2d2d36; margin-bottom: 1.2rem;
      box-shadow: 0 4px 16px 0 rgba(36,32,70,0.10);
      transition: box-shadow 0.25s, transform 0.18s;
      overflow: hidden; position: relative;
    }
    .ticket-card:hover { box-shadow: 0 10px 32px 0 rgba(36,32,70,0.18); transform: translateY(-4px) scale(1.012); }
    .ticket-card .read-btn {
      color: #818cf8; background: none; border: none; font-weight: 500;
      cursor: pointer; font-size: 1rem; transition: color 0.18s;
    }
    .ticket-card .read-btn:hover { color: #a5b4fc; }
    .skeleton {
      background: linear-gradient(90deg, #232046 25%, #312e81 50%, #232046 75%);
      background-size: 200% 100%; animation: skeleton 1.2s infinite linear;
      border-radius: 1.1rem; height: 120px; margin-bottom: 1.2rem;
    }
    @keyframes skeleton { 0% {background-position: 200% 0;} 100% {background-position: -200% 0;} }
    .modal-overlay {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(24,24,27,0.82); z-index: 50; display: flex;
      align-items: center; justify-content: center; opacity: 0; pointer-events: none;
      transition: opacity 0.25s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-dialog {
      background: #23232b; color: #e5e7eb; border-radius: 1.2rem;
      max-width: 420px; width: 96vw; padding: 2.2rem 1.5rem 1.5rem 1.5rem;
      box-shadow: 0 8px 48px 0 rgba(36,32,70,0.22);
      position: relative; animation: fade-in 0.32s cubic-bezier(0.4,0,0.2,1);
    }
    .modal-close {
      position: absolute; right: 1.1rem; top: 1.1rem; background: none; border: none;
      color: #a1a1aa; font-size: 1.5rem; cursor: pointer; transition: color 0.18s;
    }
    .modal-close:hover { color: #fff; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(32px) scale(0.98); } to { opacity: 1; transform: none; } }
    @media (max-width: 640px) {
      .search-container { padding: 1.1rem 0.5rem 1rem 0.5rem; }
      .modal-dialog { padding: 1.2rem 0.5rem 1rem 0.5rem; }
    }
  </style>
</head>
<body>
  <div class="watermark" aria-hidden="true">TicketsFinder</div>
  <div id="affridoWatermark" style="position:fixed;left:1.2rem;bottom:1.2rem;z-index:30;color:#818cf8;opacity:0.38;font-size:1.08rem;font-family:monospace;pointer-events:none;user-select:none;letter-spacing:0.04em;">made by affrido10</div>
  <main class="min-h-screen flex flex-col items-center justify-start relative z-10">
    <section class="search-container w-full flex flex-col gap-2">
      <div class="flex items-center gap-2 mb-2">
        <form id="searchForm" class="relative flex-1" autocomplete="off" spellcheck="false">
          <input id="searchInput" class="search-input pr-12" type="text" placeholder="Поиск по номеру, теме или ключевым словам..." aria-label="Поиск билета" autofocus />
          <button type="submit" class="search-btn" aria-label="Найти"><i class="fas fa-search"></i></button>
        </form>
        <button id="practiceBtn" class="px-4 py-2 rounded-lg bg-indigo-800 text-white font-semibold shadow hover:bg-indigo-900 transition text-sm whitespace-nowrap" type="button"><i class="fas fa-flask mr-1"></i>Практика</button>
        <button id="backToTicketsBtn" class="px-4 py-2 rounded-lg bg-gray-700 text-white font-semibold shadow hover:bg-gray-800 transition text-sm whitespace-nowrap hidden" type="button"><i class="fas fa-arrow-left mr-1"></i>К билетам</button>
      </div>
      <div id="searchStats" class="mt-2 text-xs text-indigo-200"></div>
    </section>
    <section class="results-list w-full px-2" id="resultsSection">
      <div id="skeletonList"></div>
      <div id="resultsContainer"></div>
      <div id="noResults" class="text-center text-gray-400 mt-8 hidden">Ничего не найдено</div>
    </section>
    <button id="showAllBtn" class="mt-4 mb-8 px-6 py-2 rounded-lg bg-indigo-700 text-white font-semibold shadow hover:bg-indigo-800 transition hidden">Показать все билеты</button>
  </main>
  <div class="modal-overlay" id="modalOverlay" tabindex="-1" aria-modal="true" role="dialog">
    <div class="modal-dialog" id="modalDialog">
      <button class="modal-close" id="modalCloseBtn" aria-label="Закрыть"><i class="fas fa-times"></i></button>
      <div id="modalContent"></div>
    </div>
  </div>
  <script>
    // --- Динамический фон ---
    const gradA1 = [24,24,27], gradA2 = [36,32,70], gradB1 = [30,32,40], gradB2 = [43,47,94];
    function lerpColor(a, b, t) {
      return [Math.round(a[0]+(b[0]-a[0])*t), Math.round(a[1]+(b[1]-a[1])*t), Math.round(a[2]+(b[2]-a[2])*t)];
    }
    function rgbToStr(rgb) { return `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`; }
    function updateBg() {
      const maxScroll = Math.max(1, document.body.scrollHeight-window.innerHeight);
      const t = Math.min(1, window.scrollY/maxScroll);
      const c1 = lerpColor(gradA1, gradB1, t), c2 = lerpColor(gradA2, gradB2, t);
      document.body.style.background = `linear-gradient(135deg, ${rgbToStr(c1)} 0%, ${rgbToStr(c2)} 100%)`;
    }
    window.addEventListener('scroll', updateBg);
    updateBg();
    // --- Watermark parallax ---
    window.addEventListener('scroll',()=>{
      const wm = document.querySelector('.watermark');
      if(wm) wm.style.transform = `translateY(${window.scrollY*0.18}px) scale(${1+Math.min(0.04,window.scrollY/4000)})`;
    });
    // --- State ---
    let ticketsData = [], filtered = [], allLoaded = false;
    const searchInput = document.getElementById('searchInput');
    const searchForm = document.getElementById('searchForm');
    const resultsContainer = document.getElementById('resultsContainer');
    const skeletonList = document.getElementById('skeletonList');
    const noResults = document.getElementById('noResults');
    const showAllBtn = document.getElementById('showAllBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalContent = document.getElementById('modalContent');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const searchStats = document.getElementById('searchStats');
    const practiceBtn = document.getElementById('practiceBtn');
    const backToTicketsBtn = document.getElementById('backToTicketsBtn');
    let practiceData = [], isPracticeMode = false;
    // --- Utils ---
    function highlight(text, query) {
      if (!query) return text;
      const safe = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const words = safe.split(/\s+/).filter(Boolean);
      if (!words.length) return text;
      const re = new RegExp('('+words.join('|')+')','gi');
      return text.replace(re, '<mark style="background:#fde68a;color:#92400e;border-radius:0.3em;padding:0 2px;">$1</mark>');
    }
    function showSkeleton(count=6) {
      skeletonList.innerHTML = '';
      for(let i=0;i<count;i++) {
        const sk = document.createElement('div'); sk.className = 'skeleton'; skeletonList.appendChild(sk);
      }
    }
    function hideSkeleton() { skeletonList.innerHTML = ''; }
    function showModal(ticket) {
      modalContent.innerHTML = `
        <div class="mb-3"><span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">${ticket.number}</span></div>
        <h4 class="text-lg font-bold mb-3">${ticket.question}</h4>
        <div class="text-base mb-6 whitespace-pre-line">${ticket.answer}</div>`;
      modalOverlay.classList.add('active');
      setTimeout(()=>{modalDialogFocus();},10);
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      modalOverlay.classList.remove('active');
      modalContent.innerHTML = '';
      document.body.style.overflow = '';
    }
    function modalDialogFocus() {
      const dialog = document.getElementById('modalDialog');
      if(dialog) dialog.focus();
    }
    function showEasterEgg() {
      modalContent.innerHTML = `
        <div class="flex flex-col items-center justify-center">
          <img src="https://cataas.com/cat/says/Мяу?width=320&height=220&fontSize=32" alt="Котик" style="border-radius:1rem;box-shadow:0 4px 24px #23204633;margin-bottom:1.2rem;max-width:90vw;">
          <div class="text-lg font-bold mb-2">Пасхалка!</div>
          <div class="text-base text-center">Вот тебе котик для настроения 🐾</div>
        </div>`;
      modalOverlay.classList.add('active');
      setTimeout(()=>{modalDialogFocus();},10);
      document.body.style.overflow = 'hidden';
    }
    function showNoResultsEasterEgg() {
      modalContent.innerHTML = `
        <div class="flex flex-col items-center justify-center">
          <img src="ticket.jpg" alt="Ticket" style="border-radius:1rem;box-shadow:0 4px 24px #23204633;margin-bottom:1.2rem;max-width:90vw;max-height:260px;">
          <div class="text-lg font-bold mb-2">Билет не найден!</div>
          <div class="text-base text-center">Но вот тебе виртуальный билет 🎟️</div>
        </div>`;
      modalOverlay.classList.add('active');
      setTimeout(()=>{modalDialogFocus();},10);
      document.body.style.overflow = 'hidden';
    }
    // --- Search ---
    function renderResults(list, query) {
      resultsContainer.innerHTML = '';
      if (!Array.isArray(list) || !list.length) {
        noResults.innerHTML = `
          <div class="flex flex-col items-center justify-center">
            <img src="ticket.jpg" alt="Ticket" style="border-radius:1rem;box-shadow:0 4px 24px #23204633;margin-bottom:1.2rem;max-width:90vw;max-height:260px;">
            <div class="text-lg font-bold mb-2">Билет не найден!</div>
            <div class="text-base text-center">НЕМА ТАКОГО НЕЕЕЕМААААА 🎟️</div>
          </div>`;
        noResults.classList.remove('hidden');
        return;
      }
      noResults.classList.add('hidden');
      noResults.innerHTML = 'Ничего не найдено';
      list.forEach(ticket => {
        if (!ticket || typeof ticket !== 'object') return;
        const card = document.createElement('div');
        card.className = 'ticket-card p-5';
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">${highlight(ticket.number||'', query)}</span>
          </div>
          <h4 class="text-lg font-semibold mb-2">${highlight(ticket.question||'', query)}</h4>
          <p class="text-gray-400 text-sm mb-3">${highlight((ticket.answer||'').substring(0, 100), query)}...</p>
          <div class="flex justify-between items-center">
            <button class="read-btn" tabindex="0"><i class="fas fa-book-open mr-1"></i> Читать</button>
          </div>`;
        card.querySelector('.read-btn').onclick = ()=>showModal(ticket);
        resultsContainer.appendChild(card);
      });
    }
    function renderPractice(list) {
      resultsContainer.innerHTML = '';
      if (!list.length) {
        noResults.innerHTML = `<div class="flex flex-col items-center justify-center">
          <img src="ticket.jpg" alt="Ticket" style="border-radius:1rem;box-shadow:0 4px 24px #23204633;margin-bottom:1.2rem;max-width:90vw;max-height:260px;">
          <div class="text-lg font-bold mb-2">Практика не найдена!</div>
          <div class="text-base text-center">Нет заданий для практики 🎟️</div>
        </div>`;
        noResults.classList.remove('hidden');
        return;
      }
      noResults.classList.add('hidden');
      list.forEach(prac => {
        const card = document.createElement('div');
        card.className = 'ticket-card p-5';
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">Практика ${prac["билет"]}</span>
          </div>
          <h4 class="text-lg font-semibold mb-2">${prac["практика"]}</h4>
          <p class="text-gray-400 text-sm mb-3">${prac["инструкция"].replace(/\n/g,' ').replace(/\*\*.*?\*\*/g,'').substring(0, 120)}...</p>
          <div class="flex justify-end items-center">
            <button class="read-btn" tabindex="0"><i class="fas fa-book-open mr-1"></i> Подробнее</button>
          </div>`;
        card.querySelector('.read-btn').onclick = ()=>showPracticeModal(prac);
        resultsContainer.appendChild(card);
      });
    }
    function renderCombinedResults(tickets, practices, query) {
      resultsContainer.innerHTML = '';
      let hasTickets = tickets.length > 0;
      let hasPractice = practices.length > 0;
      if (!hasTickets && !hasPractice) {
        noResults.innerHTML = `
          <div class="flex flex-col items-center justify-center">
            <img src="ticket.jpg" alt="Ticket" style="border-radius:1rem;box-shadow:0 4px 24px #23204633;margin-bottom:1.2rem;max-width:90vw;max-height:260px;">
            <div class="text-lg font-bold mb-2">Ничего не найдено!</div>
            <div class="text-base text-center">НЕМА ТАКОГО НЕЕЕЕМААААА 🎟️</div>
          </div>`;
        noResults.classList.remove('hidden');
        return;
      }
      noResults.classList.add('hidden');
      noResults.innerHTML = 'Ничего не найдено';
      if (hasTickets) {
        const header = document.createElement('div');
        header.className = 'text-indigo-300 text-base font-bold mb-2 mt-2';
        header.textContent = 'Билеты';
        resultsContainer.appendChild(header);
        tickets.forEach(ticket => {
          const card = document.createElement('div');
          card.className = 'ticket-card p-5';
          card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">${highlight(ticket.number, query)}</span>
            </div>
            <h4 class="text-lg font-semibold mb-2">${highlight(ticket.question, query)}</h4>
            <p class="text-gray-400 text-sm mb-3">${highlight(ticket.answer.substring(0, 100), query)}...</p>
            <div class="flex justify-between items-center">
              <button class="read-btn" tabindex="0"><i class="fas fa-book-open mr-1"></i> Читать</button>
            </div>`;
          card.querySelector('.read-btn').onclick = ()=>showModal(ticket);
          resultsContainer.appendChild(card);
        });
      }
      if (hasPractice) {
        const header = document.createElement('div');
        header.className = 'text-indigo-300 text-base font-bold mb-2 mt-4';
        header.textContent = 'Практика';
        resultsContainer.appendChild(header);
        practices.forEach(prac => {
          const card = document.createElement('div');
          card.className = 'ticket-card p-5';
          card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">Практика ${highlight(prac["билет"], query)}</span>
            </div>
            <h4 class="text-lg font-semibold mb-2">${highlight(prac["практика"], query)}</h4>
            <p class="text-gray-400 text-sm mb-3">${highlight(prac["инструкция"].replace(/\n/g,' ').replace(/\*\*.*?\*\*/g,''), query).substring(0, 120)}...</p>
            <div class="flex justify-end items-center">
              <button class="read-btn" tabindex="0"><i class="fas fa-book-open mr-1"></i> Подробнее</button>
            </div>`;
          card.querySelector('.read-btn').onclick = ()=>showPracticeModal(prac);
          resultsContainer.appendChild(card);
        });
      }
    }
    function updateStats(found, total) {
      searchStats.textContent = found ? `Найдено: ${found} из ${total}` : '';
    }
    function doSearch(query) {
      if (!ticketsData.length) return;
      if (query && query.toLowerCase().includes('котик')) {
        showEasterEgg();
        searchInput.value = '';
        return;
      }
      if (!query) {
        filtered = [];
        resultsContainer.innerHTML = '';
        noResults.classList.add('hidden');
        showAllBtn.classList.remove('hidden');
        updateStats(0, ticketsData.length);
        return;
      }
      showAllBtn.classList.add('hidden');
      showSkeleton();
      setTimeout(()=>{
        let res = [];
        const numMatch = query.match(/(билет\s*)?(\d{1,3})/i);
        if(numMatch) {
          const num = numMatch[2];
          res = ticketsData.filter(t=>t.number.replace(/[^\d]/g,'')===num);
        }
        if(!res.length) {
          const words = query.toLowerCase().split(/\s+/).filter(Boolean);
          res = ticketsData.filter(t=>words.every(w=>(t.topic+t.question+t.answer).toLowerCase().includes(w)));
        }
        filtered = res;
        hideSkeleton();
        renderResults(res, query);
        updateStats(res.length, ticketsData.length);
      }, 400);
    }
    function showPracticeModal(prac) {
      modalContent.innerHTML = `
        <div class="mb-3"><span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded">Практика ${prac["билет"]}</span></div>
        <h4 class="text-lg font-bold mb-3">${prac["практика"]}</h4>
        <div class="text-base mb-6 whitespace-pre-line">${prac["инструкция"]}</div>`;
      modalOverlay.classList.add('active');
      setTimeout(()=>{modalDialogFocus();},10);
      document.body.style.overflow = 'hidden';
    }
    function loadPractice() {
      showSkeleton();
      fetch('./practice.json').then(r=>r.json()).then(data=>{
        practiceData = Array.isArray(data) ? data : [];
        hideSkeleton();
        renderPractice(practiceData);
        updateStats(practiceData.length, practiceData.length);
      }).catch(()=>{
        hideSkeleton();
        noResults.classList.remove('hidden');
      });
    }
    practiceBtn.onclick = ()=>{
      isPracticeMode = true;
      searchForm.classList.add('hidden');
      practiceBtn.classList.add('hidden');
      backToTicketsBtn.classList.remove('hidden');
      showAllBtn.classList.add('hidden');
      noResults.classList.add('hidden');
      resultsContainer.innerHTML = '';
      loadPractice();
    };
    backToTicketsBtn.onclick = ()=>{
      isPracticeMode = false;
      searchForm.classList.remove('hidden');
      practiceBtn.classList.remove('hidden');
      backToTicketsBtn.classList.add('hidden');
      resultsContainer.innerHTML = '';
      noResults.classList.add('hidden');
      showAllBtn.classList.remove('hidden');
      updateStats(0, ticketsData.length);
    };
    // --- Show all ---
    showAllBtn.onclick = ()=>{
      renderResults(ticketsData, '');
      showAllBtn.classList.add('hidden');
      updateStats(ticketsData.length, ticketsData.length);
    };
    // --- Modal events ---
    modalCloseBtn.onclick = closeModal;
    modalOverlay.onclick = e=>{if(e.target===modalOverlay)closeModal();};
    document.addEventListener('keydown',e=>{
      if(modalOverlay.classList.contains('active')&&(e.key==='Escape'||e.key==='Esc'))closeModal();
    });
    // --- Search events ---
    searchForm.onsubmit = e=>{
      if(isPracticeMode) return;
      e.preventDefault();
      doSearch(searchInput.value.trim());
    };
    searchInput.oninput = ()=>{
      if(isPracticeMode) return;
      doSearch(searchInput.value.trim());
    };
    // --- Fetch practice on load ---
    function loadPracticeData() {
      return fetch('./practice.json').then(r=>r.json()).then(data=>{
        practiceData = Array.isArray(data) ? data : [];
      }).catch(()=>{ practiceData = []; });
    }
    // --- Tickets parser ---
    function parseTickets(raw) {
      if (!Array.isArray(raw)) {
        console.error('tickets.json не массив:', raw);
        return [];
      }
      return raw.map((t, i) => ({
        number: t["id"] ? `Билет ${t["id"]}` : t["№"] ? `Билет ${t["№"]}` : (t.number || `Билет ${i+1}`),
        topic: '', // нет темы
        question: t.question || t["Вопрос"] || '',
        answer: t.answer || t["Ответ"] || '',
        date: '' // нет даты
      }));
    }
    // --- Fetch tickets ---
    function loadTickets() {
      showSkeleton();
      fetch('./tickets.json').then(r=>{
        if (!r.ok) throw new Error('Ошибка загрузки tickets.json');
        return r.json();
      }).then(data=>{
        ticketsData = Array.isArray(data) ? parseTickets(data) : [];
        console.log('ticketsData:', ticketsData);
        // После загрузки билетов — загрузить практику
        loadPracticeData().then(()=>{
          hideSkeleton();
          if(ticketsData.length) {
            showAllBtn.classList.remove('hidden');
            updateStats(0, ticketsData.length + (practiceData.length||0));
          } else {
            noResults.classList.remove('hidden');
            noResults.innerHTML = 'Ошибка: билеты не загружены или пусты.';
          }
        });
      }).catch((e)=>{
        hideSkeleton();
        noResults.classList.remove('hidden');
        noResults.innerHTML = 'Ошибка загрузки tickets.json: ' + e;
        console.error('Ошибка загрузки tickets.json:', e);
      });
    }
    window.addEventListener('load',()=>{
      loadTickets();
    });
  </script>
</body>
</html>
